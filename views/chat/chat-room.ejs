<%- include('../includes/header')%>

<body>
<div>
    <p>Hi Dude <strong><%=user.username%></strong>, welcome to <strong><%=channel_info.name%></strong></p>
    <input id="text" name="message" type="text"/>
    <button id="butt1">send</button>

    <lu id="chatting_text"></lu>

</div>

<script type="text/javascript">
    $(function () {
        const chat_section = $('#chatting_text');

        const user_data = {username: '<%=user.username%>', mb_id: '<%=user.authorId%>'};
        const room_id = '<%=channel_info['room_id']%>';
        const room_title = '<%=channel_info['room_title']%>';

        const socket = io('http://31.220.109.104:4004', {transports: ['websocket', 'xhr-polling']});
        socket.on('connect', function () {
            console.log('browser connection on process');
        });

        socket.emit('join', {user_data: user_data, room_id: room_id}, function (err) {
            if(err) {
                console.log(err);
            } else {
                console.log(`connected to ${room_title}`);
            }
        });

        socket.on('newMessage', function (msg) {
            console.log(msg);
            if(msg.from === 'admin') {
                let html = `<li style="font-size: small; margin-top: 20px; margin-right: 40px"><strong>${msg.from}</strong>: ${msg.text} at ${msg.time}</li>`;
                chat_section.append(html);
            } else {
                let html = `<li style="display: flex; flex-direction: column; margin-top: 10px" >
                            <p mb_id='${msg.from.mb_id}'><strong>${msg.from.username}</strong></p>
                            <div style="margin-top: -20px">${msg.text}  ${msg.time}</div>
                        </li>`;
                chat_section.append(html);
            }
        });

        socket.on('connect_error', (err) => {
            console.log(err);
        });

        $('#butt1').on('click', function () {
            let text = $('input[name=message]').val();
            socket.emit('createMessage', {room_id: room_id, from: user_data, text: text, type: 'message'});
        })

    });
</script>

<%- include('../includes/footer')%>